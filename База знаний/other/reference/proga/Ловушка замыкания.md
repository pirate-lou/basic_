---
создал заметку: 2024-04-21
tags:
  - ловушка
  - замыкание
  - программирование
---
Ловушка замыкания - это ситуация, когда в лямбда-выражении используется общая переменная для всех итераций в цикле. Частый пример ловушки замыкания это, когда используется в лямбда-выражении переменная i принадлежащая циклу for. Такая переменная становится по итогу полем класса, и соответственно становится общей для всех итераций в цикле.
```c#
for (int i = 0; i < 10; i++)
	functions.Add(x => x + i);
```

Как правильно использовать:
```c#
for (int i = 0; i < 10; i++)
{
	var j = i;
	functions.Add(x => x + j);
}
```
*переменная `j` определена в фигурных скобках `for` соответсвенно анонимный объект будет каждый раз заново создаваться внутри фигурных скобок `for`, т.е. анонимный объект будет своим для каждой итерации цикла*

```c#
class Helper
{
	public int j;
}
public static void Main()
{
	for (int i = 0; i < 10; i++)
	{
		// на каждой итерации цикла свой Helper 
		var helper = new Helper();
		// у каждого helper свое значение j, которое равно на каждой итерации i 
		// они не связаны между собой 
		helper.j = i;
		list.Add(x => x + helper.j);
	}
	//Этот код выведет числа от 0 до 10,
	//потому что j - локальная для цикла,
	//и соответственно своя на каждой итерации и у каждой лямбды
	foreach (var e in functions)
		Console.WriteLine(e(1));
}
```